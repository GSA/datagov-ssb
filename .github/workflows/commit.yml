---
name: commit

on: [push]

env:
  AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
  AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
  BUCKET: "${{ secrets.BUCKET }}"
  REGION: "${{ secrets.REGION }}"
  KEY: "ssb-tfstate"
  ENCRYPT: "true"

jobs:
  test:
    name: test format and validity
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: terraform fmt
        uses: dflook/terraform-fmt-check@v1
        with:
          path: .

      - name: terraform validate
        uses: dflook/terraform-validate@v1
        with:
          path: .

  test-deployment:
    if: github.ref == 'refs/heads/develop'
    name: plan & apply (development)
    runs-on: ubuntu-latest
    environment: development
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_VAR_cf_username: ${{ secrets.TF_VAR_cf_username }}
      TF_VAR_cf_password: ${{ secrets.TF_VAR_cf_password }}
      TF_VAR_aws_access_key_id: ${{ secrets.TF_VAR_aws_access_key_id }}
      TF_VAR_aws_secret_access_key: ${{ secrets.TF_VAR_aws_secret_access_key }}
      TERRAFORM_PRE_RUN: |
        # TODO: Check sha256 sums
        HELM_VERSION="3.7.1"
        KUBECTL_VERSION="1.22.3"

        AWS_IAM_AUTH_VERSION_URL="https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator"

        BASE_URL="https://get.helm.sh"
        TAR_FILE="helm-v${HELM_VERSION}-linux-amd64.tar.gz"

        # Install the Helm binary
        curl -f -L ${BASE_URL}/${TAR_FILE} |tar xvz && \
            mv linux-amd64/helm helm && \
            chmod +x helm && \
            rm -rf linux-amd64

        # Install kubectl
        curl -f -LO https://storage.googleapis.com/kubernetes-release/release/v${KUBECTL_VERSION}/bin/linux/amd64/kubectl && \
            chmod +x kubectl

        # Install aws-iam-authenticator
        curl -f -LO ${AWS_IAM_AUTH_VERSION_URL} && \
            chmod +x aws-iam-authenticator

        cp helm /tmp/terraform-data-dir/modules/brokerpak-eks-terraform/terraform/modules/provision/
        cp kubectl /tmp/terraform-data-dir/modules/brokerpak-eks-terraform/terraform/modules/provision/
        cp aws-iam-authenticator /tmp/terraform-data-dir/modules/brokerpak-eks-terraform/terraform/modules/provision/
        /tmp/terraform-data-dir/modules/brokerpak-eks-terraform/terraform/modules/provision/aws-iam-authenticator help

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: prep applications
        run: |
          ./app-setup-eks.sh
          ./app-setup-solr.sh
          ./app-setup-solrcloud.sh
          ./app-setup-smtp.sh

      - name: terraform apply (development)
        uses: dflook/terraform-apply@v1.22.1
        with:
          path: .
          label: development
          workspace: development
          auto_approve: true
          var_file: terraform.development.tfvars
          backend_config: >
            bucket=${{ env.BUCKET }},
            key=${{ env.KEY }},
            region=${{ env.REGION }},
            encrypt=${{ env.ENCRYPT }},
            access_key=${{ env.AWS_ACCESS_KEY_ID }},
            secret_key=${{ env.AWS_SECRET_ACCESS_KEY }}
      # - name: Setup tmate session
      #   if: ${{ failure() }}
      #   uses: mxschmitt/action-tmate@v3
      #   with:
      #     limit-access-to-actor: true
      - name: test development environment
        run: echo development tests ok  # TODO development smoke tests
